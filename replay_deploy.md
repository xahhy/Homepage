# 1. Nginx
## nginx.conf
user www-data;
worker_processes auto;
pid /run/nginx.pid;

#阻塞和非阻塞网络模型：
#同步阻塞模型，一请求一进（线）程，当进（线）程增加到一定程度后
#更多CPU时间浪费到切换一，性能急剧下降，所以负载率不高
#Nginx基于事件的非阻塞多路复用(epoll或kquene)模型
#一个进程在短时间内可以响应大量的请求
#建议值 <= cpu核心数量，一般高于cpu数量不会带好处，也许还有进程切换开销的负面影响
#worker_processes 4;

#将work process绑定到特定cpu上，避免进程在cpu间切换的开销
#worker_cpu_affinity 0001 0010 0100 1000 
#8内核4进程时的设置方法 worker_cpu_affinity 00000001 00000010 00000100 10000000

# 每进程最大可打开文件描述符数量(linux上文件描述符比较广义，网络端口、设备、磁盘文件都是)
# 文件描述符用完了，新的连接会被拒绝，产生502类错误
# linux最大可打开文件数可通过ulimit -n FILECNT或 /etc/security/limits.conf配置
# 理论值 系统最大数量 / 进程数。但进程间工作量并不是平均分配的，所以可以设置的大一些
worker_rlimit_nofile 655350 ;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
#pid        logs/nginx.pid;


events {
    # 并发响应能力的关键配置值
    # 每个进程允许的最大同时连接数，work_connectins * worker_processes = maxConnection;
    # 要注意maxConnections不等同于可响应的用户数量，
    # 因为一般一个浏览器会同时开两条连接，如果反向代理，nginx到后端服务器的连接也要占用连接数
    # 所以，做静态服务器时，一般 maxClient = work_connectins * worker_processes / 2
    # 做反向代理服务器时 maxClient = work_connectins * worker_processes / 4

    # 这个值理论上越大越好，但最多可承受多少请求与配件和网络相关,也可最大可打开文件，最大可用sockets数量（约64K）有关
    worker_connections  10240;

    # 指明使用epoll 或 kquene (*BSD)
    use epoll;


    # 备注：要达到超高负载下最好的网络响应能力，还有必要优化与网络相关的linux内核参数
}

## sites-available/default
##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

upstream tomcat_server{
	server	localhost:8080;

}
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	autoindex	on;
	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	#root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

	server_name _;
	charset	utf-8;
	#location表达式：
    #syntax: location [=|~|~*|^~|@] /uri/ { … }
    #分为两种匹配模式，普通字符串匹配，正则匹配
    #无开头引导字符或以=开头表示普通字符串匹配
    #以~或~* 开头表示正则匹配，~*表示不区分大小写
    #多个location时匹配规则
    #总体是先普通后正则原则，只识别URI部分，例如请求为/test/1/abc.do?arg=xxx
    #1. 先查找是否有=开头的精确匹配，即location = /test/1/abc.do {...}
    #2. 再查找普通匹配，以 最大前缀 为规则，如有以下两个location
    #   location /test/ {...}
    #   location /test/1/ {...}
    #   则匹配后一项
    #3. 匹配到一个普通格式后，搜索并未结束，而是暂存当前结果，并继续再搜索正则模式
    #4. 在所有正则模式location中找到第一个匹配项后，以此匹配项为最终结果
    #   所以正则匹配项匹配规则受定义前后顺序影响，但普通匹配不会
    #5. 如果未找到正则匹配项，则以3中缓存的结果为最终结果
    #6. 如果一个匹配都没有，返回404

    #location =/ {...} 与 location / {...} 的差别
    #前一个是精确匹配，只响应/请求，所有/xxx类请求不会以前缀匹配形式匹配到它
    #而后一个正相反，所有请求必然都是以/开头，所以没有其它匹配结果时一定会执行到它

    #location ^~ / {...} ^~意思是非正则，表示匹配到此模式后不再继续正则搜索
    #所有如果这样配置，相当于关闭了正则匹配功能
    #因为一个请求在普通匹配规则下没得到其它普通匹配结果时，最终匹配到这里
    #而这个^~指令又相当于不允许正则，相当于匹配到此为止
	location /replay/ {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		# try_files $uri $uri/ =404;
		proxy_pass	http://tomcat_server;
	}
	
	location  /home {
		alias	/home/share/www/Homepage;
		index	index.html;
	}

	location /vod {

	}

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		#try_files $uri $uri/ =404;
		root /var/www/html;
	}

	# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php7.0-cgi alone:
	#	fastcgi_pass 127.0.0.1:9000;
	#	# With php7.0-fpm:
	#	fastcgi_pass unix:/run/php/php7.0-fpm.sock;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}
}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}

# 2. Tomcat
## apache-*7*/conf/server.xml
    <Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" 
               acceptCount="5000" maxThreads="4000" />

## apache-*7*/bin/catalina.sh
CATALINA_OPTS="-Xms1024m -Xmx1024m -Xss512K -XX:PermSize=256m -XX:MaxPermSize=256m"
# OS specific support.  $var _must_ be set to either true or false.
cygwin=false


